From 6b144413ecd010e84af44a3e7be42cdf4c6dd2ec Mon Sep 17 00:00:00 2001
From: Daniel Ching <dching@nvidia.com>
Date: Tue, 4 Feb 2025 13:06:52 -0600
Subject: [PATCH 1/3] BLD: Use only dynamic (shared library) links to CUDA
 targets

---
 cmake/Dependencies.cmake           | 4 ++--
 extensions/nvjpeg/CMakeLists.txt   | 6 +++---
 extensions/nvjpeg2k/CMakeLists.txt | 2 +-
 extensions/nvtiff/CMakeLists.txt   | 4 ++--
 python/CMakeLists.txt              | 2 +-
 src/CMakeLists.txt                 | 2 +-
 test/CMakeLists.txt                | 4 ++--
 7 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/cmake/Dependencies.cmake b/cmake/Dependencies.cmake
index 557bc32b..f4e1478b 100644
--- a/cmake/Dependencies.cmake
+++ b/cmake/Dependencies.cmake
@@ -62,7 +62,7 @@ if (BUILD_NVJPEG2K_EXT)
         set(NVJPEG2K_SEARCH_PATHS "${nvjpeg2k_headers_SOURCE_DIR}/include")
     else()
         set(NVJPEG2K_SEARCH_PATHS ${CTK_SEARCH_PATHS})
-        find_library(NVJPEG2K_LIBRARY nvjpeg2k_static PATH_SUFFIXES lib lib64)
+        find_library(NVJPEG2K_LIBRARY nvjpeg2k PATH_SUFFIXES lib lib64)
         if(NVJPEG2K_LIBRARY)
             message(STATUS "Found nvJPEG2k: ${NVJPEG2K_LIBRARY}")
         else()
@@ -100,7 +100,7 @@ if (BUILD_NVTIFF_EXT)
         set(NVTIFF_SEARCH_PATHS "${nvtiff_headers_SOURCE_DIR}/include")
     else()
         set(NVTIFF_SEARCH_PATHS ${CTK_SEARCH_PATHS})
-        find_library(NVTIFF_LIB nvtiff_static PATH_SUFFIXES lib lib64)
+        find_library(NVTIFF_LIB nvtiff PATH_SUFFIXES lib lib64)
         if(NVTIFF_LIB)
             message(STATUS "Found nvTIFF: ${NVTIFF_LIB}")
         else()
diff --git a/extensions/nvjpeg/CMakeLists.txt b/extensions/nvjpeg/CMakeLists.txt
index 04b52564..70695faf 100644
--- a/extensions/nvjpeg/CMakeLists.txt
+++ b/extensions/nvjpeg/CMakeLists.txt
@@ -79,14 +79,14 @@ endif()
 if(NOT WITH_DYNAMIC_NVJPEG)
   if(UNIX)
     target_link_libraries(${EXT_LIBRARY_NAME}
-      PUBLIC CUDA::cudart_static CUDA::nvjpeg_static CUDA::culibos)
+      PUBLIC CUDA::cudart CUDA::nvjpeg CUDA::culibos)
   else()
     target_link_libraries(${EXT_LIBRARY_NAME}
-      PUBLIC CUDA::cudart_static CUDA::nvjpeg)
+      PUBLIC CUDA::cudart CUDA::nvjpeg)
   endif()
 else()
   target_link_libraries(${EXT_LIBRARY_NAME}
-    PRIVATE CUDA::cudart_static dynlink_nvjpeg)
+    PRIVATE CUDA::cudart dynlink_nvjpeg)
   target_link_libraries(${EXT_LIBRARY_NAME}
     PRIVATE "-Wl,--exclude-libs,$<TARGET_FILE_NAME:dynlink_nvjpeg>")
 endif()
diff --git a/extensions/nvjpeg2k/CMakeLists.txt b/extensions/nvjpeg2k/CMakeLists.txt
index 903cbdf7..799fb801 100644
--- a/extensions/nvjpeg2k/CMakeLists.txt
+++ b/extensions/nvjpeg2k/CMakeLists.txt
@@ -55,7 +55,7 @@ else()
 endif()
 
 target_link_libraries(${EXT_LIBRARY_NAME} PUBLIC
-  CUDA::cudart_static)
+  CUDA::cudart)
 
 if(UNIX)
   set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -fPIC -fvisibility=hidden -Wl,--exclude-libs,ALL")
diff --git a/extensions/nvtiff/CMakeLists.txt b/extensions/nvtiff/CMakeLists.txt
index 2ee4ef3b..a4f91d38 100644
--- a/extensions/nvtiff/CMakeLists.txt
+++ b/extensions/nvtiff/CMakeLists.txt
@@ -51,7 +51,7 @@ endif()
 
 if(NOT WITH_DYNAMIC_NVJPEG)
   if(UNIX)
-    target_link_libraries(${EXT_LIBRARY_NAME} PUBLIC CUDA::nvjpeg_static CUDA::culibos)
+    target_link_libraries(${EXT_LIBRARY_NAME} PUBLIC CUDA::nvjpeg CUDA::culibos)
   else()
     target_link_libraries(${EXT_LIBRARY_NAME} PUBLIC CUDA::nvjpeg)
   endif()
@@ -60,7 +60,7 @@ else()
   target_link_libraries(${EXT_LIBRARY_NAME} PRIVATE "-Wl,--exclude-libs,$<TARGET_FILE_NAME:dynlink_nvjpeg>")
 endif()
 
-target_link_libraries(${EXT_LIBRARY_NAME} PUBLIC CUDA::cudart_static)
+target_link_libraries(${EXT_LIBRARY_NAME} PUBLIC CUDA::cudart)
 
 if (UNIX)
   set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -fPIC -fvisibility=hidden -Wl,--exclude-libs,ALL")
diff --git a/python/CMakeLists.txt b/python/CMakeLists.txt
index ddbcba54..a6ced000 100644
--- a/python/CMakeLists.txt
+++ b/python/CMakeLists.txt
@@ -73,7 +73,7 @@ build_per_python_lib(nvimgcodec_python
     OUTPUT_NAME nvimgcodec_impl
     OUTPUT_DIR ${PY_NVIMGCODEC_IMPL_OUTPUT_DIR}
     PUBLIC_LIBS nvimgcodec
-    PRIV_LIBS CUDA::cudart_static ${CUDA_DRIVER_LIB} $<TARGET_OBJECTS:nvimgcodec_imgproc_static>
+    PRIV_LIBS CUDA::cudart ${CUDA_DRIVER_LIB} $<TARGET_OBJECTS:nvimgcodec_imgproc_static>
     SRC ${PY_NVIMGCODEC_SRCS})
 
 # Setup wheel depependencies
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 3f59c8e7..7722d71b 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -137,7 +137,7 @@ else()
     set(CUDA_DRIVER_LIB CUDA::cuda_driver)
 endif()
 
-target_link_libraries(${NVIMGCODEC_LIBRARY_NAME} PRIVATE CUDA::cudart_static ${CUDA_DRIVER_LIB})
+target_link_libraries(${NVIMGCODEC_LIBRARY_NAME} PRIVATE CUDA::cudart ${CUDA_DRIVER_LIB})
 
 if(UNIX)
     # CXX flags
diff --git a/test/CMakeLists.txt b/test/CMakeLists.txt
index 3dbc8ff2..e5f21d2f 100644
--- a/test/CMakeLists.txt
+++ b/test/CMakeLists.txt
@@ -152,7 +152,7 @@ foreach(testapp nvimgcodec_tests)
     if (WITH_DYNAMIC_NVJPEG)
         list(APPEND TARGET_LIBS dynlink_nvjpeg)
     else()
-        list(APPEND TARGET_LIBS CUDA::nvjpeg_static)
+        list(APPEND TARGET_LIBS CUDA::nvjpeg)
     endif()
 
     if (BUILD_NVJPEG2K_EXT)
@@ -205,7 +205,7 @@ foreach(testapp nvimgcodec_tests)
     target_link_libraries(${testapp} PUBLIC
         ${TARGET_LIBS}
         ${OpenCV_LIBRARIES}
-        CUDA::cudart_static
+        CUDA::cudart
         CUDA::cuda_driver
         gtest
         gmock
-- 
2.49.0

